# Simple makefile to build UUAG.
# Nothing fancy, just as simple as possible to get things done quickly.
#   --Alexey

help:
	@echo Build system for the AG compiler
	@echo Targets:
	@echo
	@echo build - Build the AG compiler
	@echo clean - Clean the generated HS sources
	@echo install - Install the AG compiler
	@echo dist - Create source distributions

# Directories
SRC_DIR = src
SRC_AG_DIR = src-ag

# The following variables are set in configure
AG = @UUAGC@
LHS2TEX   = @LHS2TEX@
BUILD_DIR = @BUILD_DIR@
MV        = @MV@
RM        = @RM@
RM_F      = $(RM) -f
CP        = @CP@
FIND      = @FIND@
MKDIR     = @MKDIR@
GREP      = @GREP@
CHMOD     = @CHMOD@
VERSION   = @VERSION@
prefix    = @prefix@
MKINSTDIR = ./mkinstalldirs
INSTALL   = @INSTALL@
HC        = @HC@

# Some hardcoded settings
AG_BINARY = ./$(BUILD_DIR)/$(SRC_DIR)/uuagc
CABAL_BUILD = $(CABAL_SCRIPT) build
CABAL_CONFIGURE = $(CABAL_SCRIPT) configure
CABAL_CONFIG = .setup-config
CABAL_SOURCE = Setup.hs
CABAL_SCRIPT = ./Setup

# We generate datatype definitions for these AG files.
SRC_AG_SYN_NAMES = AbstractSyntax.ag ConcreteSyntax.ag ErrorMessages.ag\
	 Rules.ag HsToken.ag Code.ag Expression.ag Patterns.ag Interfaces.ag\
	 CodeSyntax.ag

# And semantic functions from these AG files.
SRC_AG_SEM_NAMES = DefaultRules.ag GenerateCode.ag PrintCode.ag \
	 PrintErrorMessages.ag SemHsTokens.ag SemRules.ag \
	 Transform.ag InterfacesRules.ag GenerateSeqCode.ag

# Default flags for AG
FLAGS_AG_SEM = -mcsfp --newtypes --wrappers
FLAGS_AG_SYN = -mdp
# $(FLAGS_AG_$@) specifies per-file options for $(AG).  The $@
# part has a literal value which specifies the file that it is for.
FLAGS_AG_InterfacesRules.ag = --self

SRC_AG_SYN = $(addprefix $(SRC_AG_DIR)/,$(SRC_AG_SYN_NAMES))
SRC_AG_SEM = $(addprefix $(SRC_AG_DIR)/,$(SRC_AG_SEM_NAMES))
SRC_AG = $(SRC_AG_SYN) $(SRC_AG_SEM)

# The corresponding haskell sources
SRC_HS_SYN = $(addprefix $(SRC_DIR)/,$(patsubst %.ag,%.hs,$(SRC_AG_SYN_NAMES)))
SRC_HS_SEM = $(addprefix $(SRC_DIR)/,$(patsubst %.ag,%.hs,$(SRC_AG_SEM_NAMES)))

# Generate dependencies for ag files
DEPEND_AG = ag.depend

depend_ag: $(DEPEND_AG)

DEP_PROG = scripts/mkAGdepend.sh

$(DEPEND_AG): Makefile $(SRC_AG)
	@echo "* Generating dependencies..."
	echo "# Dependencies generated by Makefile, do not edit." > $(DEPEND_AG)
	for agf in $(SRC_AG); do \
          sh $(DEP_PROG) src . $$agf >> $(DEPEND_AG); \
        done

# Dependencies between ag files
-include $(DEPEND_AG)

# Dependencies on ag files by hs files
# ugly: change directory per file
#       and the "cd .." precludes using a depth of more than one
#       and too directory specific
ifeq ($(AG),)
$(SRC_HS_SYN) $(SRC_HS_SEM): $(SRC_DIR)/%.hs: $(SRC_AG_DIR)/%.ag
	@echo "* No AG compiler configured" && exit 1
else
$(SRC_HS_SYN): $(SRC_DIR)/%.hs: $(SRC_AG_DIR)/%.ag
	cd $(SRC_AG_DIR) && \
	$(AG) $(FLAGS_AG_SYN) $(FLAGS_AG_$@) $*.ag -o ../$(SRC_DIR)/$*.hs && \
	cd ..

$(SRC_HS_SEM): $(SRC_DIR)/%.hs: $(SRC_AG_DIR)/%.ag
	cd $(SRC_AG_DIR) && \
	$(AG) $(FLAGS_AG_SEM) $(FLAGS_AG_$@) $*.ag -o ../$(SRC_DIR)/$*.hs && \
	cd ..
endif


# HS source files for uuag
SRC_HS_NAMES = Ag.hs CommonTypes.hs DepTypes.hs Expr.hs HsTokenScanner.hs Options.hs Parser.hs SequentialComputation.hs SequentialTypes.hs Scanner.hs Streaming.hs TokenDef.hs Transform.hs
SRC_HS = $(addprefix $(SRC_DIR)/,$(SRC_HS_NAMES))

build: $(AG_BINARY)

# Building the uuagc system invokes cabal build
$(AG_BINARY): $(SRC_HS) $(SRC_HS_SEM) $(SRC_HS_SYN) $(CABAL_CONFIG)
	@echo "* Compiling hs sources..."
	$(CABAL_BUILD)

$(CABAL_CONFIG): $(CABAL_SCRIPT)
	@echo "* Configuring Cabal"
	$(CABAL_CONFIGURE) --prefix=$(prefix)

$(CABAL_SCRIPT): $(CABAL_SOURCE)
	@echo "* Building Cabal script"
	$(HC) $< -o $@ -package Cabal


#
# distribution (for the time being source only and unix)
#

DISTTYPE=src

ifeq ($(DISTTYPE),win32)
        TARCZVF    := zip -r
        TAREXT     := .zip
else
        TARCZVF    := tar cvzf
        TAREXT     := .tar.gz
endif

# the name is hard-coded

TODAY  := $(shell date '+%Y-%m-%d')
DLABEL := uuagc-$(TODAY)
VLABEL := uuagc-$(VERSION)
DTLABEL:= uuagc-$(TODAY)-$(DISTTYPE)
VTLABEL:= uuagc-$(VERSION)-$(DISTTYPE)

dist_makedirs:
	$(RM_F) -r $(DLABEL)
	$(RM_F) -r $(VLABEL)
	$(MKDIR) -p $(DLABEL)
	for dir in `$(FIND) $(SRC_DIR) -type d -not -path '*/.svn*'`; do $(MKDIR) -p $(DLABEL)/$${dir}; done
	for dir in `$(FIND) $(SRC_AG_DIR) -type d -not -path '*/.svn*'`; do $(MKDIR) -p $(DLABEL)/$${dir}; done
	for dir in `$(FIND) scripts -type d -not -path '*/.svn*'`; do $(MKDIR) -p $(DLABEL)/$${dir}; done

dist_copy: dist_makedirs $(SRC_HS_SEM) $(SRC_HS_SYN)
	$(CP) -p LICENSE \
		 VERSION \
		 README \
		 Makefile.in \
		 configure \
		 configure.in \
		 uuagc.cabal \
		 uuagc.cabal.in \
		 Setup.hs \
		 install-sh \
		 mkinstalldirs \
		 $(DLABEL)
# populate source and scripts
	$(CP) -p $(SRC_DIR)/*.hs $(DLABEL)/$(SRC_DIR)
	$(CP) -p $(SRC_DIR)/*.hs.in $(DLABEL)/$(SRC_DIR)
	$(CP) -p $(SRC_AG_DIR)/*.ag $(DLABEL)/$(SRC_AG_DIR)
	$(CP) -p scripts/*.sh.in $(DLABEL)/scripts

dist_pack: dist_copy
	$(TARCZVF) $(DTLABEL)$(TAREXT) $(DLABEL)
	$(MV) $(DLABEL) $(VLABEL)
	$(TARCZVF) $(VTLABEL)$(TAREXT) $(VLABEL)

dist: dist_info dist_pack

dist_info:
	@echo "* Generating distributions..."

#
# Clean (only stuff built using uuagc)
#
clean:
	$(RM_F) $(SRC_HS_SEM) $(SRC_HS_SYN) $(GEN_HS) $(GEN_AG)

#
#
# Install

install: $(AG_BINARY)
	@echo "* Installing UUAG..."
	$(MKINSTDIR) $(prefix)/bin
	$(INSTALL) -m 755 $(AG_BINARY) $(prefix)/bin

#
# Generating AG from Literate AG (LAG)
#         or HS from Literate HS (LHS)
# And list all files for which this is done so they can be cleaned
#
%.ag : %.lag
	$(LHS2TEX) --code $< > $@
GEN_AG = $(patsubst %.lag,%.ag,$(wildcard $(SRC_AG_DIR)/*.lag))
%.hs : %.lhs
	$(LHS2TEX) --code $< > $@
GEN_HS = $(patsubst %.lhs,%.hs,$(wildcard $(SRC_DIR)/*.lhs))
